# Allogi Logging Standards

This document defines the standardized log format used across all Allogi applications to ensure consistency, readability, and proper categorization.

## üìã Standard Log Entry Structure

All logs sent to Allogi must follow this structure:

### Required Fields
```typescript
{
  id: string;           // Unique log identifier
  message: string;      // Human-readable log message
  level: LogLevel;      // Log severity level
  timestamp: string;    // ISO 8601 timestamp
  scriptId: string;     // Source script identifier
  sourceId: string;     // Source application identifier
  sourceType: string;   // Type of source component
}
```

### Optional Fields
```typescript
{
  data?: any;           // Additional structured data
  stack?: string;       // Stack trace for errors
  time?: string;        // Alternative timestamp field
  file?: string;        // Source file path
  line?: number;        // Source line number
  column?: number;      // Source column number
  functionName?: string; // Function name where log occurred
  
  // Metadata
  tags?: string[];      // Categorization tags
  category?: string;    // Error category
  severity?: string;    // Severity level
  retryable?: boolean;  // Whether error is retryable
  
  // Allogi-specific fields
  recursive?: boolean;  // Whether this is a recursive log
  moduleId?: string;    // Module identifier
  sourceVersion?: string; // Source application version
  contentType?: string; // Content type for data logs
  transmissionId?: string; // Network transmission ID
  sequenceNumber?: number; // Sequence number for ordered logs
  serverReceivedAt?: string; // When server received the log
  quality?: 'valid' | 'malformed' | 'error'; // Log quality indicator
}
```

## üè∑Ô∏è Standard Field Values

### Log Levels
- `debug` - Debug information
- `info` - General information
- `warn` - Warning messages
- `error` - Error messages
- `test` - Test-related logs

### Script IDs
- `SERVER` - Allog server components
- `unknown` - Unknown or unspecified source
- `allog-viewer` - Allog viewer application
- `allog-browser` - Allog browser extension

### Source IDs
- `SERVER` - Allog server
- `unknown` - Unknown source
- `viewer` - Allog viewer
- `client` - Client application

### Source Types
- `server` - Server component
- `request_logger` - HTTP request logging
- `error_handler` - Error handling
- `health_checker` - Health monitoring
- `metrics_collector` - Metrics collection
- `database_adapter` - Database operations
- `websocket_handler` - WebSocket handling
- `startup_shutdown` - Server lifecycle
- `application` - Application code
- `library` - Library code
- `feature` - Feature-specific code

## üîß Server Logs vs Application Logs

### Server Logs
Server logs are automatically generated by Allogi components and have:
- `scriptId: 'SERVER'`
- `sourceId: 'SERVER'`
- `recursive: true`
- Specific `sourceType` values

**Examples:**
```typescript
// Request logging
{
  id: "req_1234567890_abc123",
  message: "GET /api/logs",
  level: "info",
  timestamp: "2025-08-21T18:30:00.000Z",
  scriptId: "SERVER",
  sourceId: "SERVER",
  sourceType: "request_logger",
  data: {
    method: "GET",
    url: "/api/logs",
    statusCode: 200,
    responseTime: 45
  }
}

// Error handling
{
  id: "err_1234567890_def456",
  message: "validation: Invalid log format",
  level: "warn",
  timestamp: "2025-08-21T18:30:00.000Z",
  scriptId: "SERVER",
  sourceId: "SERVER",
  sourceType: "error_handler",
  data: {
    errorId: "err_1234567890_def456",
    category: "validation",
    endpoint: "/api/logs",
    retryable: false
  }
}
```

### Application Logs
Application logs are sent by client applications and have:
- Custom `scriptId` and `sourceId` values
- `recursive: false` (default)
- Application-specific `sourceType` values

**Examples:**
```typescript
// Client application log
{
  id: "log_1234567890_ghi789",
  message: "User login successful",
  level: "info",
  timestamp: "2025-08-21T18:30:00.000Z",
  scriptId: "user-auth",
  sourceId: "myapp",
  sourceType: "authentication",
  data: {
    userId: "user123",
    loginMethod: "password"
  }
}

// Library log
{
  id: "log_1234567890_jkl012",
  message: "Database connection established",
  level: "debug",
  timestamp: "2025-08-21T18:30:00.000Z",
  scriptId: "db-connector",
  sourceId: "myapp",
  sourceType: "library",
  data: {
    connectionString: "postgresql://...",
    poolSize: 10
  }
}
```

## üìù Log Formatting

### Server Logs
Server logs are automatically formatted for better readability:
- **Message**: Clean, concise description
- **Details**: Formatted metadata (time, level, etc.)
- **Metadata**: Additional structured information
- **Visual**: Blue theme with üîß icon

### Application Logs
Application logs maintain their original format:
- **Message**: As provided by the application
- **Data**: Raw JSON data (if provided)
- **Visual**: Green theme

## ‚úÖ Validation

All logs are validated using `LogValidator`:

```typescript
import { LogValidator } from './utils/LogConstants';

// Check if log is valid
if (LogValidator.isValid(logEntry)) {
  // Process log
}

// Check if it's a server log
if (LogValidator.isServerLog(logEntry)) {
  // Format as server log
}

// Normalize log entry
const normalizedLog = LogValidator.normalize(logEntry);
```

## üöÄ Best Practices

### For Client Applications
1. **Use descriptive scriptId**: `"user-authentication"` not `"auth"`
2. **Include relevant data**: Add context that helps with debugging
3. **Use appropriate levels**: Don't log everything as `info`
4. **Add tags**: Use tags for categorization and filtering

### For Server Components
1. **Use consistent field values**: Always use `'SERVER'` for server logs
2. **Provide meaningful messages**: Clear, actionable descriptions
3. **Include relevant metadata**: Add context without verbosity
4. **Use proper source types**: Choose from predefined list

### For Log Consumers
1. **Check log validity**: Validate before processing
2. **Handle missing fields**: Use normalization for incomplete logs
3. **Respect log levels**: Filter by appropriate severity
4. **Use tags for filtering**: Leverage tag-based categorization

## üîç Log Detection Logic

Server logs are automatically detected using multiple criteria:

1. **Explicit flag**: `recursive: true`
2. **Script ID**: Contains "server" (case-insensitive)
3. **Source ID**: Contains "server" (case-insensitive)
4. **Source Type**: Contains logger/handler/checker/collector/adapter

This ensures robust detection regardless of case variations or field naming inconsistencies.

## üìä Log Storage and Limits

- **Application Logs**: Stored in main log array (default: 2,000 entries)
- **Server Logs**: Stored separately (default: 1,000 entries)
- **Monitoring Data**: Stored separately (default: 5,000 entries)
- **Persistence**: All logs are persisted to storage when enabled
- **Rotation**: Automatic log rotation when limits are reached

## üîÑ Migration Guide

If you have existing logs that don't follow this format:

1. **Update field names**: Ensure required fields are present
2. **Standardize values**: Use predefined field values where possible
3. **Add missing fields**: Include `scriptId`, `sourceId`, `sourceType`
4. **Test validation**: Verify logs pass `LogValidator.isValid()`

## üìö Related Files

- `viewer-app/src/utils/LogConstants.ts` - Standard interfaces and constants
- `viewer-app/src/utils/LogFormatter.ts` - Log formatting utilities
- `server/intermediary-server.js` - Server-side log handling
- `server/error-handler.js` - Error logging
- `server/health-checker.js` - Health check logging
- `server/metrics-collector.js` - Metrics logging
