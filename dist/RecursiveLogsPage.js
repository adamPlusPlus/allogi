import{useState as a,useEffect as O,useCallback as d}from"react";import{createAllogApiClient as X}from"@formwise/allog-api-client";var $={network:{ports:{viewer:3001,server:3002},urls:{defaultServer:"http://localhost:3002",alternativeServer:"http://localhost:8080",productionServer:"https://api.example.com/allog"},connection:{timeout:5e3,retries:3,minTimeout:1e3,maxTimeout:3e4,retryDelay:1e3}},refresh:{intervals:{default:3e4,minimum:1e3,options:[1e3,2e3,5e3,1e4,3e4]},autoRefresh:{enabled:!1,minInterval:3e4}},logging:{levels:{valid:["info","warn","error","debug","test"],default:"info",colors:{info:"#007AFF",warn:"#FF9500",error:"#FF3B30",debug:"#888888",test:"#6c757d"}},internal:{maxLogs:1e3,enableConsole:!0,defaultLevel:"info"}},ui:{colors:{status:{connected:"#28a745",error:"#dc3545",neutral:"#6c757d",warning:"#FF9500"},script:["#4ec9b0","#569cd6","#dcdcaa","#ce9178","#c586c0","#6a9955","#d7ba7d","#9cdcfe","#f44747","#ff7f50"]},layout:{imagePreview:{maxWidth:"100%",maxHeight:300,borderRadius:4},notification:{autoHideDelay:3e3,fadeOutDuration:300}}},buffers:{logs:{default:500,maximum:1e4},stats:{enabledModules:0,totalModules:0}},instrumentation:{levels:{none:"none",basic:"basic",detailed:"detailed",comprehensive:"comprehensive"},defaults:{enabled:!0,level:"detailed"}},defaults:{fallback:{sourceId:"unknown",scriptId:"unknown",sourceType:"unknown",sourceVersion:"1.0.0"},messages:{loading:"Loading logs...",noLogs:"No logs available",noMatching:"No logs match your current filters",disconnected:"Not connected to server",connectionFailed:"Connection failed"}},export:{formats:["csv","json"],filenamePrefixes:{logs:"allog-logs",stats:"allog-stats",config:"allog-config"}}};var C=class{constructor(){this.config=$}get viewerPort(){return this.config.network.ports.viewer}get serverPort(){return this.config.network.ports.server}get defaultServerUrl(){return this.config.network.urls.defaultServer}get alternativeServerUrl(){return this.config.network.urls.alternativeServer}get productionServerUrl(){return this.config.network.urls.productionServer}get connectionTimeout(){return this.config.network.connection.timeout}get connectionRetries(){return this.config.network.connection.retries}get minTimeout(){return this.config.network.connection.minTimeout}get maxTimeout(){return this.config.network.connection.maxTimeout}get defaultRefreshInterval(){return this.config.refresh.intervals.default}get minRefreshInterval(){return this.config.refresh.intervals.minimum}get refreshOptions(){return this.config.refresh.intervals.options}get autoRefreshEnabled(){return this.config.refresh.autoRefresh.enabled}get minAutoRefreshInterval(){return this.config.refresh.autoRefresh.minInterval}get validLogLevels(){return this.config.logging.levels.valid}get defaultLogLevel(){return this.config.logging.levels.default}get logLevelColors(){return this.config.logging.levels.colors}get maxInternalLogs(){return this.config.logging.internal.maxLogs}get enableConsoleLogging(){return this.config.logging.internal.enableConsole}get defaultInternalLogLevel(){return this.config.logging.internal.defaultLevel}get statusColors(){return this.config.ui.colors.status}get scriptColors(){return this.config.ui.colors.script}get imagePreviewConfig(){return this.config.ui.layout.imagePreview}get notificationConfig(){return this.config.ui.layout.notification}get defaultLogBuffer(){return this.config.buffers.logs.default}get maxLogBuffer(){return this.config.buffers.logs.maximum}get instrumentationLevels(){return this.config.instrumentation.levels}get defaultInstrumentationEnabled(){return this.config.instrumentation.defaults.enabled}get defaultInstrumentationLevel(){return this.config.instrumentation.defaults.level}get fallbackValues(){return this.config.defaults.fallback}get defaultMessages(){return this.config.defaults.messages}get exportFormats(){return this.config.export.formats}get exportFilenamePrefixes(){return this.config.export.filenamePrefixes}isValidLogLevel(o){return this.validLogLevels.includes(o)}getLogLevelColor(o){return this.logLevelColors[o]||this.statusColors.neutral}getScriptColor(o){let n=this.scriptColors,c=(o||this.fallbackValues.scriptId).split("").reduce((s,p)=>(s=(s<<5)-s+p.charCodeAt(0),s&s),0);return n[Math.abs(c)%n.length]}getStatusColor(o){return this.statusColors[o]||this.statusColors.neutral}getConnectionConfig(){return{baseUrl:this.defaultServerUrl,timeout:this.connectionTimeout,retries:this.connectionRetries}}getWebSocketUrl(o){let n=window.location.protocol==="https:"?"wss":"ws",l=window.location.hostname,c=o||window.location.port,s=c===this.viewerPort.toString()?this.serverPort.toString():c||this.serverPort.toString();return`${n}://${l}:${s}`}getApiServerUrl(){let o=window.location.hostname,l=window.location.port===this.serverPort.toString()?this.viewerPort.toString():this.serverPort.toString();return`http://${o}:${l}`}formatMessage(o,n={}){return(this.defaultMessages[o]||o).replace(/\{(\w+)\}/g,(c,s)=>n[s]||c)}getServerUrl(){return window.ALLOG_INTERMEDIARY_URL||this.defaultServerUrl}getInitialLogStats(){return{totalLogs:0,bufferSize:this.defaultLogBuffer,enabledModules:this.config.buffers.stats.enabledModules,totalModules:this.config.buffers.stats.totalModules,logLevels:this.validLogLevels.reduce((o,n)=>(o[n]=0,o),{}),lastUpdate:new Date().toISOString()}}getInitialConnectionStatus(){return{isConnected:!1,retryCount:0}}getInitialMonitoringStats(){return{totalModules:0,totalScripts:0,totalVariables:0,totalStates:0,totalFunctions:0,totalProperties:0,totalEvents:0,lastUpdate:new Date().toISOString()}}},Q=new C,h=Q;import{jsx as t,jsxs as r}from"react/jsx-runtime";function Z({serverUrl:x,autoRefresh:o,refreshInterval:n}){let[l,c]=a([]),[s,p]=a({level:"",scriptId:"",search:""}),[S,j]=a(new Set),[B,N]=a(!1),[R,I]=a(null),[v,q]=a({totalRecursiveLogs:0,byScript:{},byLevel:{}}),[P,z]=a(null),[g,H]=a(null),[w]=a(()=>X(x)),M=d(async()=>{console.log("\u{1F504} RecursiveLogsPage: Fetching logs from server:",x);let e=await w.getRecursiveLogs();return console.log("\u2705 RecursiveLogsPage: Received logs:",e.length,"logs"),e},[w,x]),T=d(async()=>{let e=await w.getRecursiveLogsStats();return console.log("\u{1F4CA} RecursiveLogsPage: Received stats:",e),e},[w]),b=d(async()=>{try{let e=await M();c(e),N(!0),I(null);let i=await T();q(i)}catch(e){console.error("\u274C RecursiveLogsPage: Error fetching logs:",e),I(`Connection failed: ${e instanceof Error?e.message:"Unknown error"}`),N(!1)}},[M,T]),A=d(()=>{console.log("\u{1F504} RecursiveLogsPage: Component mounted")},[]),U=d(()=>{console.log("\u{1F504} RecursiveLogsPage: Component unmounting")},[]);O(()=>{if(!o)return;let e=Math.max(n,3e4),i=setInterval(()=>{b()},e);return()=>clearInterval(i)},[o,n,b]),O(()=>{A(),b();let e=setInterval(()=>{console.log("\u{1F504} RecursiveLogsPage: Periodic activity heartbeat",{component:"RecursiveLogsPage",timestamp:Date.now(),logCount:l.length})},6e4);return()=>{clearInterval(e),U()}},[b,A,U]);let Y=d(e=>{j(i=>{let f=new Set(i);return f.has(e)?f.delete(e):f.add(e),f}),console.log("\u{1F504} RecursiveLogsPage: User interaction - Log expansion toggled",{action:"toggleLogExpansion",logId:e,timestamp:Date.now()})},[]),W=d(e=>{z(e)},[]),y=d(e=>{H(i=>i?.key===e?{key:e,direction:i.direction==="asc"?"desc":"asc"}:{key:e,direction:"asc"}),console.log("\u{1F504} RecursiveLogsPage: User interaction - Logs sorted",{action:"requestSort",sortKey:e,timestamp:Date.now()})},[]),k=e=>g?.key!==e?"\u2195\uFE0F":g.direction==="asc"?"\u2191":"\u2193",_=e=>g?[...e].sort((i,f)=>{let u=i[g.key],m=f[g.key];return g.key==="time"?(u=new Date(u).getTime(),m=new Date(m).getTime()):typeof u=="string"&&(u=u.toLowerCase(),m=m.toLowerCase()),u<m?g.direction==="asc"?-1:1:u>m?g.direction==="asc"?1:-1:0}):e,L=l.filter(e=>!(s.level&&e.level!==s.level||s.scriptId&&e.scriptId!==s.scriptId||s.search&&!e.message.toLowerCase().includes(s.search.toLowerCase()))),F=_(L),G=Array.from(new Set(l.map(e=>e.scriptId))).sort(),J=h.validLogLevels,D=e=>h.getLogLevelColor(e),E=e=>h.getScriptColor(e||h.fallbackValues.scriptId),V=e=>new Date(e).toLocaleTimeString();return r("div",{className:"recursive-logs-page",children:[r("div",{className:"recursive-logs-header",children:[t("h2",{children:"\u{1F504} Recursive Logs"}),t("p",{className:"recursive-logs-description",children:"Self-referential logs from the Allog system itself. These logs show how the logging system operates."}),r("div",{className:"recursive-logs-status",children:[t("span",{className:"status-indicator",children:"\u{1F504} Active Filtering"}),t("span",{className:"status-detail",children:"Showing only self-logging scripts"})]})]}),r("div",{className:"recursive-logs-stats",children:[r("div",{className:"stat-card",children:[t("div",{className:"stat-number",children:v.totalRecursiveLogs}),t("div",{className:"stat-label",children:"Total Recursive Logs"})]}),r("div",{className:"stat-card",children:[t("div",{className:"stat-number",children:Object.keys(v.byScript).length}),t("div",{className:"stat-label",children:"Self-Logging Scripts"})]}),r("div",{className:"stat-card",children:[t("div",{className:"stat-number",children:Object.keys(v.byLevel).length}),t("div",{className:"stat-label",children:"Log Levels"})]})]}),r("div",{className:"recursive-logs-content",children:[r("div",{className:"recursive-logs-table-column",children:[r("div",{className:"recursive-logs-table-header",children:[t("h3",{children:"\u{1F4CA} Recursive Logs Table"}),t("button",{className:"refresh-btn",onClick:b,disabled:!B,children:"\u{1F504} Refresh"})]}),t("div",{className:"recursive-logs-table",children:r("table",{children:[t("thead",{children:r("tr",{children:[r("th",{className:"sortable",onClick:()=>y("scriptId"),children:["Script ",k("scriptId")]}),r("th",{className:"sortable",onClick:()=>y("level"),children:["Level ",k("level")]}),r("th",{className:"sortable",onClick:()=>y("time"),children:["Time ",k("time")]}),r("th",{className:"sortable",onClick:()=>y("message"),children:["Message ",k("message")]})]})}),t("tbody",{children:F.length===0?t("tr",{children:t("td",{colSpan:4,className:"no-data",children:l.length===0?"No recursive logs found":"No logs match current filter"})}):F.map(e=>r("tr",{className:`table-row ${P?.id===e.id?"selected":""}`,onClick:()=>W(e),children:[t("td",{className:"table-script",style:{color:E(e.scriptId)},children:e.scriptId||"unknown"}),t("td",{children:t("span",{className:"table-level",style:{color:D(e.level)},children:e.level.toUpperCase()})}),t("td",{className:"table-time",children:V(e.time)}),t("td",{className:"table-message",children:e.message})]},e.id))})]})})]}),r("div",{className:"recursive-logs-logs-column",children:[r("div",{className:"recursive-logs-filters",children:[r("div",{className:"filter-group",children:[t("label",{children:"Script:"}),r("select",{value:s.scriptId,onChange:e=>p(i=>({...i,scriptId:e.target.value})),children:[t("option",{value:"",children:"All Scripts"}),G.map(e=>r("option",{value:e,children:[e," (",v.byScript[e]||0,")"]},e))]})]}),r("div",{className:"filter-group",children:[t("label",{children:"Level:"}),r("select",{value:s.level,onChange:e=>p(i=>({...i,level:e.target.value})),children:[t("option",{value:"",children:"All Levels"}),J.map(e=>r("option",{value:e,children:[e.toUpperCase()," (",v.byLevel[e]||0,")"]},e))]})]}),r("div",{className:"filter-group",children:[t("label",{children:"Search:"}),t("input",{type:"text",placeholder:"Search in messages...",value:s.search,onChange:e=>p(i=>({...i,search:e.target.value}))})]}),t("button",{className:"clear-btn",onClick:()=>{p({level:"",scriptId:"",search:""}),z(null)},children:"Clear Filters"})]}),R&&r("div",{className:"error-message",children:["Error: ",R]}),t("div",{className:"recursive-logs-list",children:L.length===0?t("div",{className:"no-logs",children:l.length===0?"No recursive logs found":"No logs match current filter"}):L.map(e=>r("div",{className:`log-entry ${S.has(e.id)?"expanded":""} ${P?.id===e.id?"selected":""}`,"data-script-id":e.scriptId,children:[r("div",{className:"log-header",onClick:()=>Y(e.id),children:[t("div",{className:"log-level",style:{color:D(e.level)},children:e.level.toUpperCase()}),t("div",{className:"log-time",children:V(e.time)}),t("div",{className:"log-script",style:{color:E(e.scriptId)},children:e.scriptId}),t("div",{className:"log-message",children:e.message}),t("div",{className:"log-expand",children:"\u25B6"})]}),S.has(e.id)&&r("div",{className:"log-details",children:[e.data&&r("div",{className:"log-data",children:[t("strong",{children:"Data:"}),t("pre",{children:JSON.stringify(e.data,null,2)})]}),e.file&&r("div",{className:"log-file",children:[t("strong",{children:"File:"})," ",e.file,":",e.line,":",e.column,e.functionName&&` (${e.functionName})`]}),e.stack&&r("div",{className:"log-stack",children:[t("strong",{children:"Stack:"}),t("pre",{children:e.stack})]})]})]},e.id))})]})]})]})}export{Z as default};
