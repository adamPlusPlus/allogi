import{useState as h,useEffect as $,useCallback as m,useRef as de,forwardRef as Ie,useImperativeHandle as we}from"react";import{Fragment as B,jsx as a,jsxs as d}from"react/jsx-runtime";var Ce=Ie(({isOpen:s,onToggle:A,onSave:y,onLoad:P,onDelete:v,onExport:k,onImport:I,currentData:N,currentView:E,onCreateHighlight:C},V)=>{let[o,u]=h({items:[],expandedFolders:new Set,selectedItem:null,editingItem:null,activeProfile:null}),[x,G]=h(""),[f,M]=h("profile"),[J,te]=h(!1),[ae,O]=h(!1),L=de(new Map),[r,Q]=h({isVisible:!1,x:0,y:0,targetItem:null}),[j,Z]=h(null),[X,g]=h(""),[D,oe]=h({total:0,buffer:500,modules:0,info:0,warn:0,error:0,debug:0,scripts:15,variables:30,states:45,functions:30,properties:30,events:30});$(()=>{let e=localStorage.getItem("allog-save-system");if(e)try{let t=JSON.parse(e),i=t.items||[],n=R(i);u(c=>({...c,items:n,expandedFolders:new Set(t.expandedFolders||[]),activeProfile:t.activeProfile||null}))}catch{ie()}else ie()},[]);let ie=m(()=>{let e=[{id:"default-profile",name:"Default Profile",type:"profile",metadata:{description:"Default profile for all saves",tags:["default"],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}},{id:"default-highlight",name:"Highlights",type:"highlight",parentId:"default-profile",metadata:{description:"Default highlight category",tags:["default","highlight"],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}},{id:"default-comparison",name:"Comparisons",type:"comparison",parentId:"default-profile",metadata:{description:"Default comparison category",tags:["default","comparison"],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}},{id:"default-filter-preset",name:"Filter Presets",type:"filter-preset",parentId:"default-profile",metadata:{description:"Default filter presets category",tags:["default","filter"],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}},{id:"default-view-preset",name:"View Presets",type:"view-preset",parentId:"default-profile",metadata:{description:"Default view presets category",tags:["default","view"],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}},{id:"default-log-session",name:"Log Sessions",type:"log-session",parentId:"default-profile",metadata:{description:"Default log sessions category",tags:["default","log"],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}},{id:"default-monitoring-session",name:"Monitoring Sessions",type:"monitoring-session",parentId:"default-profile",metadata:{description:"Default monitoring sessions category",tags:["default","monitoring"],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}}];u(t=>({...t,items:e,expandedFolders:new Set(["default-profile"])}))},[]),T=m(e=>{if(!e)return null;if(e.type==="profile")return e;if(e.parentId){let t=o.items.find(i=>i.id===e.parentId);if(t)return t.type==="profile"?t:T(t)}return null},[o.items]),F=m((e,t)=>{let i=new Date().toISOString(),n=e.replace("profile-","");return[{id:`${n}-highlight`,name:"Highlights",type:"highlight",parentId:e,metadata:{description:`${t} highlight category`,tags:[t.toLowerCase(),"highlight"],createdAt:i,updatedAt:i}},{id:`${n}-comparison`,name:"Comparisons",type:"comparison",parentId:e,metadata:{description:`${t} comparison category`,tags:[t.toLowerCase(),"comparison"],createdAt:i,updatedAt:i}},{id:`${n}-filter-preset`,name:"Filter Presets",type:"filter-preset",parentId:e,metadata:{description:`${t} filter presets category`,tags:[t.toLowerCase(),"filter"],createdAt:i,updatedAt:i}},{id:`${n}-view-preset`,name:"View Presets",type:"view-preset",parentId:e,metadata:{description:`${t} view presets category`,tags:[t.toLowerCase(),"view"],createdAt:i,updatedAt:i}},{id:`${n}-log-session`,name:"Log Sessions",type:"log-session",parentId:e,metadata:{description:`${t} log sessions category`,tags:[t.toLowerCase(),"log"],createdAt:i,updatedAt:i}},{id:`${n}-monitoring-session`,name:"Monitoring Sessions",type:"monitoring-session",parentId:e,metadata:{description:`${t} monitoring sessions category`,tags:[t.toLowerCase(),"monitoring"],createdAt:i,updatedAt:i}}]},[]),R=m(e=>{console.log("SaveSystem: Ensuring default structure exists...");let t=e.some(w=>w.id==="default-profile"),i=e.some(w=>w.id==="default-highlight"),n=e.some(w=>w.id==="default-comparison"),c=e.some(w=>w.id==="default-filter-preset"),p=e.some(w=>w.id==="default-view-preset"),b=e.some(w=>w.id==="default-log-session"),l=e.some(w=>w.id==="default-monitoring-session"),S=[];return t||S.push({id:"default-profile",name:"Default Profile",type:"profile",metadata:{description:"Default profile for all saves",tags:["default"],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}}),i||S.push({id:"default-highlight",name:"Highlights",type:"highlight",parentId:"default-profile",metadata:{description:"Default highlight category",tags:["default","highlight"],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}}),n||S.push({id:"default-comparison",name:"Comparisons",type:"comparison",parentId:"default-profile",metadata:{description:"Default comparison category",tags:["default","comparison"],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}}),c||S.push({id:"default-filter-preset",name:"Filter Presets",type:"filter-preset",parentId:"default-profile",metadata:{description:"Default filter presets category",tags:["default","filter"],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}}),p||S.push({id:"default-view-preset",name:"View Presets",type:"view-preset",parentId:"default-profile",metadata:{description:"Default view presets category",tags:["default","view"],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}}),b||S.push({id:"default-log-session",name:"Log Sessions",type:"log-session",parentId:"default-profile",metadata:{description:"Default log sessions category",tags:["default","log"],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}}),l||S.push({id:"default-monitoring-session",name:"Monitoring Sessions",type:"monitoring-session",parentId:"default-profile",metadata:{description:"Default monitoring sessions category",tags:["default","monitoring"],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}}),S.length>0?(console.log("SaveSystem: Adding missing default items:",S),[...e,...S]):e},[]);$(()=>{console.log("SaveSystem: Saving state to localStorage:",{items:o.items,expandedFolders:Array.from(o.expandedFolders),activeProfile:o.activeProfile}),localStorage.setItem("allog-save-system",JSON.stringify({items:o.items,expandedFolders:Array.from(o.expandedFolders),activeProfile:o.activeProfile}))},[o.items,o.expandedFolders,o.activeProfile]),$(()=>{let e=()=>{Q(t=>({...t,isVisible:!1}))};if(r.isVisible)return document.addEventListener("click",e),()=>document.removeEventListener("click",e)},[r.isVisible]);let H=m(()=>{if(console.log("SaveSystem: Creating new item:",{newItemName:x,newItemType:f,selectedItem:o.selectedItem}),!x.trim())return;let e=f==="profile"||f==="highlight"||f==="comparison"||f==="filter-preset"||f==="view-preset"||f==="log-session"||f==="monitoring-session",t=f.includes("-")&&f!=="filter-preset"&&f!=="view-preset"&&f!=="log-session"&&f!=="monitoring-session";if(e){let i;if(f==="profile")i=void 0;else{let c=T(o.selectedItem);if(!c){console.warn("\u274C Please select a profile or a subfolder within a profile to create this item.");return}i=c.id}let n={id:`folder-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,name:x.trim(),type:f,parentId:i,metadata:{description:"",tags:[],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}};console.log("SaveSystem: Creating new folder:",n),u(c=>{let p=[...c.items,n];if(f==="profile"){let l=F(n.id,n.name);p=[...p,...l],console.log("SaveSystem: Created default folders for new profile:",l)}let b={...c,items:p};return f==="profile"&&(b.expandedFolders=new Set(Array.from(c.expandedFolders).concat(n.id))),console.log("SaveSystem: New state after creating folder:",b),b})}else if(t){if(!o.selectedItem||o.selectedItem.type!=="highlight"&&o.selectedItem.type!=="comparison"&&o.selectedItem.type!=="filter-preset"&&o.selectedItem.type!=="view-preset"&&o.selectedItem.type!=="log-session"&&o.selectedItem.type!=="monitoring-session"){console.warn("\u274C Please select a category (highlight, comparison, etc.) first to create a save node.");return}let i={id:`node-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,name:x.trim(),type:f,parentId:o.selectedItem.id,metadata:{description:"",tags:[],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),data:N,target:x.trim()}};console.log("SaveSystem: Creating new node:",i),u(n=>{let c={...n,items:[...n.items,i]};return console.log("SaveSystem: New state after creating node:",c),c})}G(""),M("profile"),te(!1)},[x,f,o.selectedItem,N,F,T]),Y=m(e=>{u(t=>{let i=new Set(t.expandedFolders);return i.has(e)?i.delete(e):i.add(e),{...t,expandedFolders:i}})},[]),U=m(e=>{let t=T(e);u(i=>({...i,selectedItem:e,activeProfile:t})),e.type==="profile"?M("highlight"):e.type==="highlight"?M("highlight-script"):e.type==="comparison"&&M("comparison")},[T]),W=m(e=>{u(t=>({...t,editingItem:e})),O(!0)},[]),_=m(e=>{let t=o.items.find(p=>p.id===e),i=t?.type==="profile"||t?.type==="profile-settings",n=t?.type?.startsWith("highlight-");if(i&&!window.confirm("Are you sure you want to delete this profile?"))return;let c=[e];if(t?.type==="profile"){let p=o.items.find(b=>b.type==="profile-settings"&&b.parentId===e);p&&c.push(p.id)}if(u(p=>({...p,items:p.items.filter(b=>!c.includes(b.id)),selectedItem:p.selectedItem&&!c.includes(p.selectedItem.id)?p.selectedItem:null,editingItem:p.editingItem&&!c.includes(p.editingItem.id)?p.editingItem:null,activeProfile:p.activeProfile&&!c.includes(p.activeProfile.id)?p.activeProfile:null})),c.forEach(p=>v(p)),n){let p=new CustomEvent("highlight-updated",{detail:{highlightId:e,deleted:!0}});window.dispatchEvent(p)}},[v,o.items]),ee=m(e=>{let t={...e,id:`${e.type}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,name:`${e.name} (Copy)`,metadata:{...e.metadata,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}};u(i=>({...i,items:[...i.items,t]}))},[]),K=m(e=>{Z(e),g(e.name)},[]),ne=m(()=>{j&&X.trim()&&u(e=>({...e,items:e.items.map(t=>t.id===j.id?{...t,name:X.trim()}:t),selectedItem:e.selectedItem?.id===j.id?{...e.selectedItem,name:X.trim()}:e.selectedItem})),Z(null),g("")},[j,X]),ce=m(()=>{Z(null),g("")},[]),z=m((e,t)=>{let i=`save-item-${t.id}`,n=Date.now(),c=L.current.get(i);if(console.log("SaveSystem: Right-click detected on item:",t.name,"elementId:",i,"target:",e.target,"currentTarget:",e.currentTarget),c&&n-c.lastClick<300){c.timeout&&clearTimeout(c.timeout),L.current.delete(i),console.log("SaveSystem: Double right-click detected - allowing native context menu");return}c?.timeout&&clearTimeout(c.timeout);let p=setTimeout(()=>{L.current.delete(i)},300);L.current.set(i,{lastClick:n,timeout:p}),e.preventDefault(),e.stopPropagation();let b=T(t);u(l=>({...l,selectedItem:t,activeProfile:b})),Q({isVisible:!0,x:e.clientX,y:e.clientY,targetItem:t,targetElement:e.currentTarget})},[U]),xe=m(e=>{let t="tree-container",i=Date.now(),n=L.current.get(t);if(console.log("SaveSystem: Right-click detected on tree container, target:",e.target,"currentTarget:",e.currentTarget),n&&i-n.lastClick<300){n.timeout&&clearTimeout(n.timeout),L.current.delete(t),console.log("SaveSystem: Double right-click detected - allowing native context menu");return}n?.timeout&&clearTimeout(n.timeout);let c=setTimeout(()=>{L.current.delete(t)},300);L.current.set(t,{lastClick:i,timeout:c}),e.preventDefault(),e.stopPropagation(),e.target===e.currentTarget&&Q({isVisible:!0,x:e.clientX,y:e.clientY,targetItem:null,targetElement:e.currentTarget})},[]),be=m(e=>{switch(e){case"profile":return["last-ui"];case"highlight":return["highlight-script","highlight-module","highlight-method","highlight-value"];case"comparison":return["comparison"];case"filter-preset":case"view-preset":case"log-session":case"monitoring-session":return["last-ui"];default:return[]}},[]),pe=m((e,t)=>{let i=`New ${t.replace("-"," ").replace(/\b\w/g,p=>p.toUpperCase())}`,n={id:`node-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,name:i,type:t,parentId:e.id,metadata:{description:`Auto-generated ${t} node`,tags:["auto-generated",t],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),data:{},highlightData:t.startsWith("highlight-")?{color:"#ff0000",pattern:"default"}:void 0,comparisonData:t==="comparison"?{operation:"equals",leftOperand:"",rightOperand:"",isValid:!1}:void 0}};u(p=>({...p,items:[...p.items,n],selectedItem:n}));let c={items:[...o.items,n],expandedFolders:Array.from(o.expandedFolders)};localStorage.setItem("allog-save-system",JSON.stringify(c))},[o.items,o.expandedFolders]),ge=m(e=>{let t=o.items.find(l=>l.type==="highlight"&&l.parentId==="default-profile");t||(t={id:"default-highlight",name:"Highlights",type:"highlight",parentId:"default-profile",metadata:{description:"Default highlight category",tags:["default","highlight"],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}},u(l=>({...l,items:[...l.items,t]})));let i="highlight-value";e.scriptId&&e.moduleId?i="highlight-script":e.moduleId&&(i="highlight-module");let n=e.name;if(e.data){if(e.data.type&&e.data.name&&e.moduleId&&e.scriptId){let l=e.moduleId.split("/"),S=l[l.length-1],w=e.scriptId.split("/"),le=w[w.length-1];n=`.[${S}/${le}]-${e.data.name}`}else if(e.data.message&&e.scriptId){let l=e.scriptId.split("/"),S=l[l.length-1],w=e.data.message,le=w.length>30?w.substring(0,30).replace(/\s+\w*$/,"")+"...":w;n=`.[${S}]-${le}`}}let c={id:`highlight-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,name:n,type:i,parentId:t.id,metadata:{description:e.description,tags:e.tags,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),data:e.data,target:e.data?.name||e.data?.message||e.name,highlightData:{scriptId:e.scriptId,moduleId:e.moduleId,color:"#ffff00",pattern:"default"}}};u(l=>({...l,items:[...l.items,c],selectedItem:c}));let p={items:[...o.items,c],expandedFolders:Array.from(o.expandedFolders)};localStorage.setItem("allog-save-system",JSON.stringify(p)),C&&C(e);let b=new CustomEvent("highlight-updated",{detail:{highlightId:c.id,created:!0}});return window.dispatchEvent(b),c},[o.items,o.expandedFolders,C]),ue=m(e=>{let t=o.items.find(i=>{if(i.type?.startsWith("highlight-")&&i.metadata?.highlightData){let n=i.metadata.highlightData;if(n.scriptId&&e.scriptId&&!e.scriptId.includes(n.scriptId)||n.moduleId&&e.moduleId&&!e.moduleId.includes(n.moduleId)||n.valueId&&e.name&&!e.name.includes(n.valueId))return!1;if(e.elementType==="log"&&i.metadata?.target&&e.logMessage)return e.logMessage.toLowerCase().includes(i.metadata.target.toLowerCase());if(e.name&&i.metadata?.target)return e.name.toLowerCase().includes(i.metadata.target.toLowerCase());if(i.metadata?.target){if(e.elementType==="log"&&e.logMessage)return e.logMessage.toLowerCase().includes(i.metadata.target.toLowerCase());if(e.name)return e.name.toLowerCase().includes(i.metadata.target.toLowerCase())}return!1}return!1});if(t){u(p=>({...p,items:p.items.filter(b=>b.id!==t.id)}));let n={items:o.items.filter(p=>p.id!==t.id),expandedFolders:Array.from(o.expandedFolders)};localStorage.setItem("allog-save-system",JSON.stringify(n));let c=new CustomEvent("highlight-updated",{detail:{highlightId:t.id,removed:!0}});return window.dispatchEvent(c),!0}return!1},[o.items,o.expandedFolders]);we(V,()=>({createHighlightFromData:ge,removeHighlightForElement:ue}),[ge,ue]);let re=m((e,t)=>({id:`profile-settings-${e}`,name:"Profile Settings",type:"profile-settings",parentId:e,metadata:{description:`Settings for ${t}`,tags:["profile","settings","system"],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),data:{theme:"dark",autoSave:!0,notifications:!0,defaultView:"logs",instrumentation:{enabled:!0,defaultLevel:"detailed",components:{},methods:{logMethodCalls:!0,logMethodParameters:!0,logMethodReturns:!0,logMethodTiming:!0,logMethodErrors:!0},state:{logVariableChanges:!0,logConfigurationChanges:!0,logBufferOperations:!0,logModuleStateChanges:!0,logServerCommunication:!0},dataFlow:{logDataTransformation:!0,logDataRouting:!0,logDataFiltering:!0,logDataSerialization:!0},performance:{logExecutionTime:!0,logMemoryUsage:!0,logBufferStats:!0,logServerLatency:!0}}}}}),[]),me=m(()=>{let e=`New Profile ${o.items.filter(c=>c.type==="profile").length+1}`,t={id:`profile-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,name:e,type:"profile",metadata:{description:"New profile",tags:["new","profile"],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}},i=re(t.id,t.name);console.log("SaveSystem: Creating new profile:",t),u(c=>{let p=[...c.items,t,i],b=F(t.id,t.name);p=[...p,...b],console.log("SaveSystem: Created default folders for new profile:",b);let l={...c,items:p,selectedItem:t,expandedFolders:new Set(Array.from(c.expandedFolders).concat(t.id))};return console.log("SaveSystem: New state after creating profile:",l),l});let n={items:[...o.items,t,i,...F(t.id,t.name)],expandedFolders:Array.from(o.expandedFolders).concat(t.id)};localStorage.setItem("allog-save-system",JSON.stringify(n))},[o.items,o.expandedFolders,F,re]),q=m((e,t)=>{switch(e){case"create-profile":me();break;case"open":r.targetItem&&P(r.targetItem);break;case"edit":r.targetItem&&W(r.targetItem);break;case"rename":r.targetItem&&K(r.targetItem);break;case"duplicate":r.targetItem&&ee(r.targetItem);break;case"delete":r.targetItem&&_(r.targetItem.id);break;case"properties":if(r.targetItem&&r.targetItem.type==="profile"){let i=o.items.find(n=>n.type==="profile-settings"&&n.parentId===r.targetItem.id);if(i)W(i);else{let n=re(r.targetItem.id,r.targetItem.name);u(c=>({...c,items:[...c.items,n]})),W(n)}}break;case"create-node":t&&r.targetItem&&pe(r.targetItem,t);break}Q(i=>({...i,isVisible:!1}))},[r.targetItem,r.targetElement,me,P,W,K,ee,_,pe]),Se=o.items,fe=(e,t)=>e.filter(n=>n.parentId===t&&n.type!=="profile-settings").map(n=>{if(n.type==="profile"||n.type==="highlight"||n.type==="comparison"||n.type==="filter-preset"||n.type==="view-preset"||n.type==="log-session"||n.type==="monitoring-session"){let p=fe(e,n.id);return{...n,children:p}}return n}),he=fe(Se),ye=e=>{if(e.type==="profile"||e.type==="highlight"||e.type==="comparison"||e.type==="filter-preset"||e.type==="view-preset"||e.type==="log-session"||e.type==="monitoring-session")switch(e.type){case"profile":return"\u{1F464}";case"highlight":return"\u{1F50D}";case"comparison":return"\u2696\uFE0F";case"filter-preset":return"\u{1F527}";case"view-preset":return"\u{1F441}\uFE0F";case"log-session":return"\u{1F4CB}";case"monitoring-session":return"\u{1F4CA}";default:return"\u{1F4C1}"}else switch(e.type){case"profile-settings":return"\u2699\uFE0F";case"last-ui":return"\u{1F5A5}\uFE0F";case"highlight-script":return"\u{1F4DC}";case"highlight-module":return"\u{1F4E6}";case"highlight-method":return"\u{1F527}";case"highlight-value":return"\u{1F48E}";case"comparison":return"\u2696\uFE0F";default:return"\u{1F4C4}"}},se=e=>e.type==="profile"||e.type==="highlight"||e.type==="comparison"||e.type==="filter-preset"||e.type==="view-preset"||e.type==="log-session"||e.type==="monitoring-session"?`\\${e.name}`:`.${e.name}`,ve=(e,t=0)=>{let i=o.expandedFolders.has(e.id),n=o.selectedItem?.id===e.id,c=e.type==="profile"||e.type==="highlight"||e.type==="comparison"||e.type==="filter-preset"||e.type==="view-preset"||e.type==="log-session"||e.type==="monitoring-session",p=c&&"children"in e&&e.children&&e.children.length>0,b=j?.id===e.id;return d("div",{className:"tree-item-container",onContextMenu:l=>z(l,e),children:[d("div",{className:`tree-item ${n?"selected":""}`,style:{paddingLeft:`${t*20+10}px`},onClick:()=>U(e),onContextMenu:l=>z(l,e),children:[d("div",{className:"tree-item-content",onContextMenu:l=>z(l,e),children:[c&&a("span",{className:"expand-icon",onClick:l=>{l.stopPropagation(),Y(e.id)},onContextMenu:l=>z(l,e),children:i?"\u25BC":"\u25B6"}),a("span",{className:"item-icon",onContextMenu:l=>z(l,e),children:ye(e)}),b?a("input",{type:"text",value:X,onChange:l=>g(l.target.value),onBlur:ne,onKeyDown:l=>{l.key==="Enter"?ne():l.key==="Escape"&&ce()},className:"rename-input",autoFocus:!0}):a("span",{className:"item-name",onContextMenu:l=>z(l,e),children:se(e)})]}),n&&!b&&d("div",{className:"item-actions",onContextMenu:l=>z(l,e),children:[e.parentId&&(e.type==="highlight"||e.type==="comparison"||e.type==="filter-preset"||e.type==="view-preset"||e.type==="log-session"||e.type==="monitoring-session")||e.type==="profile-settings"?null:a("button",{className:"action-btn",onClick:S=>{S.stopPropagation(),W(e)},onContextMenu:S=>z(S,e),title:"Edit",children:"\u270F\uFE0F"}),a("button",{className:"action-btn",onClick:l=>{l.stopPropagation(),P(e)},onContextMenu:l=>z(l,e),title:"Load",children:"\u{1F4C2}"}),a("button",{className:"action-btn",onClick:l=>{l.stopPropagation(),k(e)},onContextMenu:l=>z(l,e),title:"Export",children:"\u{1F4E4}"}),e.parentId&&(e.type==="highlight"||e.type==="comparison"||e.type==="filter-preset"||e.type==="view-preset"||e.type==="log-session"||e.type==="monitoring-session")||e.type==="profile-settings"?null:a("button",{className:"action-btn",onClick:S=>{S.stopPropagation(),_(e.id)},onContextMenu:S=>z(S,e),title:"Delete",children:"\u{1F5D1}\uFE0F"})]})]}),c&&i&&a("div",{className:"tree-children",children:p?e.children.map(l=>ve(l,t+1)):a("div",{className:"empty-folder",style:{paddingLeft:`${(t+1)*20+10}px`,color:"#666",fontStyle:"italic"},children:"Empty folder"})})]},e.id)};return d("div",{className:`save-system ${s?"open":""}`,children:[s&&d("div",{className:"save-system-content",children:[d("div",{className:"new-item-section",children:[a("button",{className:"new-item-btn",onClick:()=>te(!J),children:J?"Cancel":"+ New Save"}),a("button",{className:"import-btn",onClick:()=>{let e=document.createElement("input");e.type="file",e.accept=".json",e.style.display="none",e.onchange=t=>{let i=t.target.files?.[0];i&&I(i),document.body.removeChild(e)},document.body.appendChild(e),e.click()},title:"Import JSON file",children:"\u{1F4E5} Import"}),J&&d("div",{className:"new-item-form",children:[a("input",{type:"text",placeholder:"Save name...",value:x,onChange:e=>G(e.target.value),className:"new-item-input"}),a("select",{value:f,onChange:e=>M(e.target.value),className:"new-item-type-select",children:d("optgroup",{label:"Nodes",children:[o.selectedItem?.type==="profile"&&d(B,{children:[a("option",{value:"profile-settings",children:"Profile Settings"}),a("option",{value:"last-ui",children:"Last UI"})]}),o.selectedItem?.type==="highlight"&&d(B,{children:[a("option",{value:"highlight-script",children:"Highlight Script"}),a("option",{value:"highlight-module",children:"Highlight Module"}),a("option",{value:"highlight-method",children:"Highlight Method"}),a("option",{value:"highlight-value",children:"Highlight Value"})]}),o.selectedItem?.type==="comparison"&&a("option",{value:"comparison",children:"Comparison"}),(o.selectedItem?.type==="filter-preset"||o.selectedItem?.type==="view-preset"||o.selectedItem?.type==="log-session"||o.selectedItem?.type==="monitoring-session")&&d(B,{children:[a("option",{value:"profile-settings",children:"Profile Settings"}),a("option",{value:"last-ui",children:"Last UI"})]})]})}),a("button",{className:"create-btn",onClick:H,disabled:!x.trim(),children:"Create"})]})]}),a("div",{className:"tree-container",onContextMenu:xe,children:he.length===0?d("div",{className:"empty-state",children:[a("p",{children:"No saves found"}),a("p",{children:"Create your first save to get started"})]}):he.map(e=>ve(e))}),o.selectedItem&&d("div",{className:"selected-item-details",children:[a("h4",{children:se(o.selectedItem)}),a("p",{className:"item-type",children:o.selectedItem.type}),o.selectedItem.metadata?.description&&a("p",{className:"item-description",children:o.selectedItem.metadata.description}),d("div",{className:"item-metadata",children:[d("span",{children:["Created: ",new Date(o.selectedItem.metadata?.createdAt||"").toLocaleDateString()]}),d("span",{children:["Updated: ",new Date(o.selectedItem.metadata?.updatedAt||"").toLocaleDateString()]})]}),o.activeProfile&&o.activeProfile.id!==o.selectedItem.id&&d("div",{className:"active-profile-indicator",children:[a("span",{className:"active-profile-label",children:"Active Profile:"}),a("span",{className:"active-profile-name",children:se(o.activeProfile)})]})]})]}),a(Ne,{item:o.editingItem,isOpen:ae,onClose:()=>{O(!1),u(e=>({...e,editingItem:null}))},onSave:e=>{u(t=>({...t,items:t.items.map(i=>i.id===e.id?e:i),editingItem:null})),O(!1)},items:o.items}),r.isVisible&&a("div",{className:"context-menu",style:{left:r.x,top:r.y},onClick:e=>e.stopPropagation(),children:r.targetItem?d(B,{children:[d("div",{className:"context-menu-item",onClick:()=>q("open"),children:[a("span",{className:"context-menu-icon",children:"\u{1F4C2}"}),"Open"]}),r.targetItem.parentId&&(r.targetItem.type==="highlight"||r.targetItem.type==="comparison"||r.targetItem.type==="filter-preset"||r.targetItem.type==="view-preset"||r.targetItem.type==="log-session"||r.targetItem.type==="monitoring-session")||r.targetItem.type==="profile-settings"?null:d("div",{className:"context-menu-item",onClick:()=>q("edit"),children:[a("span",{className:"context-menu-icon",children:"\u270F\uFE0F"}),"Edit"]}),r.targetItem.parentId&&(r.targetItem.type==="highlight"||r.targetItem.type==="comparison"||r.targetItem.type==="filter-preset"||r.targetItem.type==="view-preset"||r.targetItem.type==="log-session"||r.targetItem.type==="monitoring-session")||r.targetItem.type==="profile-settings"?null:d(B,{children:[a("div",{className:"context-menu-separator"}),d("div",{className:"context-menu-item",onClick:()=>q("rename"),children:[a("span",{className:"context-menu-icon",children:"\u270F\uFE0F"}),"Rename"]})]}),r.targetItem.parentId&&(r.targetItem.type==="highlight"||r.targetItem.type==="comparison"||r.targetItem.type==="filter-preset"||r.targetItem.type==="view-preset"||r.targetItem.type==="log-session"||r.targetItem.type==="monitoring-session")||r.targetItem.type==="profile-settings"?null:d("div",{className:"context-menu-item",onClick:()=>q("duplicate"),children:[a("span",{className:"context-menu-icon",children:"\u{1F4CB}"}),"Duplicate"]}),r.targetItem.type!=="profile"&&r.targetItem.type!=="profile-settings"&&r.targetItem.type!=="last-ui"&&r.targetItem.type!=="highlight-script"&&r.targetItem.type!=="highlight-module"&&r.targetItem.type!=="highlight-method"&&r.targetItem.type!=="highlight-value"&&r.targetItem.type!=="comparison"&&d(B,{children:[a("div",{className:"context-menu-separator"}),be(r.targetItem.type).map(e=>d("div",{className:"context-menu-item",onClick:()=>q("create-node",e),children:[a("span",{className:"context-menu-icon",children:e==="profile-settings"?"\u2699\uFE0F":e==="last-ui"?"\u{1F5A5}\uFE0F":e==="highlight-script"?"\u{1F4DC}":e==="highlight-module"?"\u{1F4E6}":e==="highlight-method"?"\u{1F527}":e==="highlight-value"?"\u{1F48E}":e==="comparison"?"\u2696\uFE0F":"\u{1F4C4}"}),"Create ",e.replace("-"," ").replace(/\b\w/g,t=>t.toUpperCase())]},e))]}),a("div",{className:"context-menu-separator"}),d("div",{className:"context-menu-item",onClick:()=>q("properties"),children:[a("span",{className:"context-menu-icon",children:"\u2139\uFE0F"}),"Properties"]}),r.targetItem.parentId&&(r.targetItem.type==="highlight"||r.targetItem.type==="comparison"||r.targetItem.type==="filter-preset"||r.targetItem.type==="view-preset"||r.targetItem.type==="log-session"||r.targetItem.type==="monitoring-session")||r.targetItem.type==="profile-settings"?null:d(B,{children:[a("div",{className:"context-menu-separator"}),d("div",{className:"context-menu-item context-menu-item-danger",onClick:()=>q("delete"),children:[a("span",{className:"context-menu-icon",children:"\u{1F5D1}\uFE0F"}),"Delete"]})]})]}):a(B,{children:d("div",{className:"context-menu-item",onClick:()=>q("create-profile"),children:[a("span",{className:"context-menu-icon",children:"\u{1F464}"}),"Create New Profile"]})})})]})}),Ne=({item:s,isOpen:A,onClose:y,onSave:P,items:v})=>{let[k,I]=h(s),[N,E]=h(s?.metadata?.description||""),[C,V]=h(s?.metadata?.tags?.join(", ")||""),[o,u]=h(!1),[x,G]=h(!1),[f,M]=h(s?.name||""),J=de(null);$(()=>{s&&(I(s),E(s.metadata?.description||""),V(s.metadata?.tags?.join(", ")||""),M(s.name))},[s]);let te=m(g=>{if(!g)return null;if(g.type==="profile")return g;if(g.parentId){let D=v.find(oe=>oe.id===g.parentId);if(D)return D.type==="profile"?D:te(D)}return null},[v]),ae=te(s),O=de(null);if($(()=>{x&&J.current&&(J.current.focus(),J.current.select())},[x]),$(()=>{s&&M(s.name)},[s]),$(()=>{if(!A||!O.current||!s)return;let g=()=>{if(!O.current)return;let F=document.querySelector(".save-system"),R=document.querySelector(".monitoring-detail"),H=window.innerWidth<=768,Y=F?.classList.contains("open")?H?280:300:0,U=0;if(R){let ee=window.getComputedStyle(R),K=R.getBoundingClientRect();ee.display!=="none"&&ee.visibility!=="hidden"&&ee.opacity!=="0"&&K.width>0&&K.height>0&&(U=K.width>0?K.width:H?320:400)}let W=Y,_=`calc(100vw - ${Y}px - ${U}px)`;O.current.style.setProperty("--save-editor-left",`${W}px`),O.current.style.setProperty("--save-editor-width",_),console.log("SaveEditor positioning:",{saveSystemWidth:Y,monitoringDetailWidth:U,left:W,width:_,isMobile:H,monitoringDetailExists:!!R,monitoringDetailStyle:R?window.getComputedStyle(R).display:"N/A"})};g();let D=new MutationObserver(g);D.observe(document.body,{attributes:!0,attributeFilter:["class","style"],subtree:!0});let oe=F=>{F.target===O.current&&u(!0)},ie=F=>{if(!o||!O.current)return;let R=O.current.getBoundingClientRect(),H=window.innerHeight-F.clientY,Y=300,U=window.innerHeight*.8;H>=Y&&H<=U&&(O.current.style.height=`${H}px`)},T=()=>{u(!1)};return o&&(document.addEventListener("mousemove",ie),document.addEventListener("mouseup",T)),window.addEventListener("resize",g),()=>{D.disconnect(),document.removeEventListener("mousemove",ie),document.removeEventListener("mouseup",T),window.removeEventListener("resize",g)}},[A,o,s]),!s)return null;let L=()=>{G(!0),M(s.name)},r=g=>{M(g.target.value)},Q=g=>{g.key==="Enter"?Z():g.key==="Escape"&&(G(!1),M(s.name))},j=()=>{Z()},Z=()=>{if(f.trim()&&f!==s.name&&k){let g={...k,name:f.trim(),metadata:{...k.metadata,createdAt:k.metadata?.createdAt||new Date().toISOString(),updatedAt:new Date().toISOString()}};I(g),P(g)}G(!1)},X=()=>{if(!k)return;let g={...k,metadata:{...k.metadata,description:N,tags:C.split(",").map(D=>D.trim()).filter(D=>D),createdAt:k.metadata?.createdAt||new Date().toISOString(),updatedAt:new Date().toISOString()}};if(P(g),g.type?.startsWith("highlight-")){let D=new CustomEvent("highlight-updated",{detail:{highlightId:g.id,updated:!0}});window.dispatchEvent(D)}};return d("div",{className:`save-editor ${A?"open":""}`,ref:O,children:[d("div",{className:"save-editor-header",onMouseDown:g=>{(g.target===g.currentTarget||g.target===g.currentTarget.querySelector("h3")||g.target===g.currentTarget.querySelector("input"))&&u(!0)},children:[d("h3",{children:["Edit"," ",x?a("input",{ref:J,type:"text",value:f,onChange:r,onKeyDown:Q,onBlur:j,className:"title-edit-input",autoFocus:!0}):a("span",{className:"editable-title",onClick:L,title:"Click to edit title",children:s.name}),ae&&ae.id!==s.id&&d("span",{className:"parent-profile-name",children:[" ","\u2022 ",ae.name]})]}),a("button",{className:"close-btn",onClick:y,children:"\u2715"})]}),d("div",{className:"save-editor-content",children:[d("div",{className:"editor-section",children:[a("label",{children:"Description:"}),a("textarea",{value:N,onChange:g=>E(g.target.value),placeholder:"Enter description...",rows:3})]}),d("div",{className:"editor-section",children:[a("label",{children:"Tags:"}),a("input",{type:"text",value:C,onChange:g=>V(g.target.value),placeholder:"Enter tags separated by commas..."})]}),!("children"in s)&&s.type==="comparison"&&a(ke,{item:s,onUpdate:g=>I(g)}),!("children"in s)&&s.type.startsWith("highlight-")&&a(De,{item:s,onUpdate:g=>I(g)}),!("children"in s)&&s.type==="profile-settings"&&a(Ae,{item:s,onUpdate:g=>I(g)}),d("div",{className:"editor-actions",children:[a("button",{className:"save-btn",onClick:X,children:"Save"}),a("button",{className:"cancel-btn",onClick:y,children:"Cancel"})]})]})]})},ke=({item:s,onUpdate:A})=>{let[y,P]=h(s.metadata?.comparisonData?.operation||""),[v,k]=h(JSON.stringify(s.metadata?.comparisonData?.leftOperand||"")),[I,N]=h(JSON.stringify(s.metadata?.comparisonData?.rightOperand||"")),E=m(()=>{try{let C={...s,metadata:{...s.metadata,createdAt:s.metadata?.createdAt||new Date().toISOString(),updatedAt:new Date().toISOString(),comparisonData:{operation:y,leftOperand:JSON.parse(v),rightOperand:JSON.parse(I),isValid:!0,result:null}}};A(C)}catch(C){console.error("Invalid JSON in comparison operands:",C)}},[s,y,v,I,A]);return $(()=>{E()},[y,v,I,E]),d("div",{className:"editor-section",children:[a("h4",{children:"Comparison Settings"}),d("div",{className:"comparison-inputs",children:[d("div",{children:[a("label",{children:"Operation:"}),d("select",{value:y,onChange:C=>P(C.target.value),children:[a("option",{value:"",children:"Select operation..."}),a("option",{value:"equals",children:"Equals"}),a("option",{value:"not-equals",children:"Not Equals"}),a("option",{value:"greater-than",children:"Greater Than"}),a("option",{value:"less-than",children:"Less Than"}),a("option",{value:"contains",children:"Contains"}),a("option",{value:"matches",children:"Matches Pattern"})]})]}),d("div",{children:[a("label",{children:"Left Operand:"}),a("textarea",{value:v,onChange:C=>k(C.target.value),placeholder:"Enter left operand...",rows:2})]}),d("div",{children:[a("label",{children:"Right Operand:"}),a("textarea",{value:I,onChange:C=>N(C.target.value),placeholder:"Enter right operand...",rows:2})]})]})]})},De=({item:s,onUpdate:A})=>{let[y,P]=h(s.metadata?.highlightData?.color||"#ffff00"),[v,k]=h(s.metadata?.highlightData?.pattern||""),I=m(()=>{let N={...s,metadata:{...s.metadata,createdAt:s.metadata?.createdAt||new Date().toISOString(),updatedAt:new Date().toISOString(),highlightData:{...s.metadata?.highlightData,color:y,pattern:v}}};A(N)},[s,y,v,A]);return $(()=>{I()},[y,v,I]),$(()=>{let N=new CustomEvent("highlight-updated",{detail:{highlightId:s.id,color:y,pattern:v}});window.dispatchEvent(N)},[y,v,s.id]),d("div",{className:"editor-section",children:[a("h4",{children:"Highlight Settings"}),d("div",{className:"highlight-inputs",children:[d("div",{children:[a("label",{children:"Color:"}),a("input",{type:"color",value:y,onChange:N=>P(N.target.value)})]}),d("div",{children:[a("label",{children:"Pattern:"}),a("input",{type:"text",value:v,onChange:N=>k(N.target.value),placeholder:"Enter highlight pattern..."})]})]})]})},Ae=({item:s,onUpdate:A})=>{let[y,P]=h(s.metadata?.data?.theme||"dark"),[v,k]=h(s.metadata?.data?.autoSave??!0),[I,N]=h(s.metadata?.data?.notifications??!0),[E,C]=h(s.metadata?.data?.defaultView||"logs"),[V,o]=h(s.metadata?.data?.instrumentation?.enabled??!0),u=m(()=>{let x={...s,metadata:{...s.metadata,createdAt:s.metadata?.createdAt||new Date().toISOString(),updatedAt:new Date().toISOString(),data:{theme:y,autoSave:v,notifications:I,defaultView:E,instrumentation:{...s.metadata?.data?.instrumentation,enabled:V}}}};A(x)},[s,y,v,I,E,V,A]);return $(()=>{u()},[y,v,I,E,V,u]),d("div",{className:"editor-section",children:[a("h4",{children:"Profile Settings"}),d("div",{className:"profile-settings-inputs",children:[d("div",{children:[a("label",{children:"Theme:"}),d("select",{value:y,onChange:x=>P(x.target.value),children:[a("option",{value:"dark",children:"Dark"}),a("option",{value:"light",children:"Light"}),a("option",{value:"auto",children:"Auto"})]})]}),d("div",{children:[a("label",{children:"Auto Save:"}),a("input",{type:"checkbox",checked:v,onChange:x=>k(x.target.checked)})]}),d("div",{children:[a("label",{children:"Notifications:"}),a("input",{type:"checkbox",checked:I,onChange:x=>N(x.target.checked)})]}),d("div",{children:[a("label",{children:"Default View:"}),d("select",{value:E,onChange:x=>C(x.target.value),children:[a("option",{value:"logs",children:"Logs"}),a("option",{value:"monitoring",children:"Monitoring"})]})]})]})]})},ze=Ce;export{ze as default};
